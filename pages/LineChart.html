<!DOCTYPE html>
<html style="height: 100%">
<head>
    <meta charset="utf-8">
    <title>在线制作标准折线图</title>
    
    <!-- 引入必要的CSS -->
    <link rel="stylesheet" href="https://staticfile.lddgo.net/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="https://staticfile.lddgo.net/js/third/tool/handsontable-12.1.2/dist/handsontable.full.min.css">
    
    <style type="text/css">
        body { margin: 0; padding: 0; height: 100%; overflow: auto; }
        .main_content { padding: 15px; max-width: 1600px; margin: 0 auto; }
        #chartArea { width: 100%; max-width: 1800px; height: 480px; margin: 10px auto; }
        .layui-form-item { margin-bottom: 15px; }
        .layui-btn-container { text-align: center; margin-top: 20px; }
        .main_title { text-align: center; margin: 20px 0; }
        .tag_container { text-align: center; margin: 10px 0; }
        .tag_anchor { color: #01AAED; margin: 0 8px; }
        #tableArea { margin: 20px 0; }
        #editEChartContainer { padding: 15px; }
        #editChartOptionContainer { height: 400px; border: 1px solid #ddd; }
    </style>
</head>

<body style="height:100%; overflow:auto; background-color: #f2f2f2;">
    <div class="main_content">
        <!-- 标题和导航 -->
        <div>
            <h1 class="main_title">在线制作标准折线图</h1>
            <div class="tag_container">
                <span>标签：</span>
                <a class="tag_anchor" href="#">图表</a>
                <a class="tag_anchor" href="#">折线图</a>
                <a class="tag_anchor" href="#">数据可视化</a>
            </div>
        </div>

        <!-- 图表显示区域 -->
        <div style="overflow-x: auto;">
            <div id="chartArea"></div>
        </div>

        <!-- 控制表单 -->
        <div class="layui-form layui-form-pane" lay-filter="chartForm" style="background: white; padding: 20px; border-radius: 5px;">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">图表宽度</label>
                    <div class="layui-input-inline">
                        <input type="number" name="chartWidth" id="chartWidth" value="800" min="1" max="1000000" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">图表高度</label>
                    <div class="layui-input-inline">
                        <input type="number" name="chartHeight" id="chartHeight" value="480" min="1" max="1000000" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">下载格式</label>
                    <div class="layui-input-inline">
                        <select name="exportFormat" id="exportFormat">
                            <option value="jpg" selected>jpg</option>
                            <option value="png">png</option>
                            <option value="pdf">pdf</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">主题</label>
                    <div class="layui-input-inline">
                        <select name="theme" id="theme">
                            <option value="light" selected>明亮</option>
                            <option value="dark">黑暗</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">样式</label>
                    <div class="layui-input-inline">
                        <select name="style" id="style">
                            <option value="smoothed" selected>曲线</option>
                            <option value="basic">折线</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">标记</label>
                    <div class="layui-input-inline">
                        <select name="marker" id="marker">
                            <option value="show" selected>显示</option>
                            <option value="hidden">不显示</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-inline">
                        <input type="text" name="title" id="title" value="网站访问统计" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">子标题</label>
                    <div class="layui-input-inline">
                        <input type="text" name="subTitle" id="subTitle" value="www.lddgo.net" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline layui-btn-container">
                    <button class="layui-btn layui-btn-primary" id="startUpload">上传Excel</button>
                    <button class="layui-btn" id="startGenerate">生成图表</button>
                    <button class="layui-btn layui-btn-normal" id="startCustom">自定义配置</button>
                    <button class="layui-btn layui-btn-primary" id="startDownload">下载图表</button>
                </div>
            </div>
        </div>

        <!-- 数据表格区域 -->
        <div id="tableArea"></div>

        <!-- 使用说明 -->
        <div style="background: white; padding: 20px; border-radius: 5px; margin-top: 20px;">
            <fieldset class="layui-elem-field layui-field-title">
                <legend>使用说明</legend>
            </fieldset>
            <div>
                <ol>
                    <li>在线制作折线图或平滑折线图，支持下载为 jpg, png 图片和 pdf 文件</li>
                    <li>图表宽度和图表高度：自定义图表的宽度和高度，单位为像素</li>
                    <li>在线编辑下方表格里的数据，然后点击生成，即可使用填写的数据重新生成折线图</li>
                    <li>表格数据的格式为：第一列为 X 轴数据，作为文本处理。从第二列开始，每一列生成一条折线</li>
                    <li>上传Excel：支持上传 xls, xlsx Excel表格文件</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 自定义配置弹窗 -->
    <div id="edit_chart_options" style="display: none;">
        <div id="editEChartContainer">
            <blockquote class="layui-elem-quote">
                如果你熟悉 ECharts 的用法，可以在此处自定义图表配置。
                <a href="https://echarts.apache.org/zh/option.html#title" style="color:#01AAED;" target="_blank">ECharts配置参考文档</a>
            </blockquote>
            <div id="editChartOptionContainer"></div>
        </div>
    </div>

    <!-- 引入必要的JavaScript库 -->
    <script type="text/javascript" src="https://staticfile.lddgo.net/layui/layui.all.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/tool/beautify/echarts-5.3.3.min.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/tool/handsontable-12.1.2/dist/handsontable.full.min.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/tool/handsontable-12.1.2/dist/languages/zh-CN.min.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/tool/download.min.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/tool/dev/jspdf.umd.min.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/tool/dev/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://staticfile.lddgo.net/js/third/src-noconflict/ace.js"></script>

    <script type="text/javascript">
        // 初始化变量
        let myChart = null;
        let hot = null;
        let chartOptionsEditor = null;

        // 默认数据
        const defaultData = [
            ['10.18', 1, 5, 6]
        ];

        // 初始化图表
        function initChart() {
            const chartDom = document.getElementById('chartArea');
            myChart = echarts.init(chartDom);
            
            const option = getChartOption();
            myChart.setOption(option);
            
            // 窗口大小变化时重绘图表
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // 获取图表配置
        function getChartOption() {
            const title = document.getElementById('title').value;
            const subTitle = document.getElementById('subTitle').value;
            const theme = document.getElementById('theme').value;
            const style = document.getElementById('style').value;
            const marker = document.getElementById('marker').value;
            
            // 从表格获取数据
            let xAxisData = [];
            let seriesData = [[], [], []];
            const seriesNames = ['Fund', 'ETF', 'Total'];
            const colors = ['#5470c6', '#91cc75', '#ee6666'];
            
            if (hot) {
                const data = hot.getData();
                xAxisData = data.map(row => row[0]);
                for (let i = 0; i < 3; i++) {
                    seriesData[i] = data.map(row => parseFloat(row[i + 1]) || 0);
                }
            }

            return {
                title: {
                    text: title,
                    subtext: subTitle,
                    left: 'center',
                    top: 'top'
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: seriesNames,
                    left: 'center',
                    top: 'bottom'
                },
                xAxis: {
                    type: 'category',
                    data: xAxisData
                },
                yAxis: {
                    type: 'value'
                },
                series: seriesNames.map((name, index) => ({
                    name: name,
                    type: 'line',
                    data: seriesData[index],
                    smooth: style === 'smoothed',
                    itemStyle: {
                        color: colors[index]
                    },
                    label: {
                        show: marker === 'show'
                    }
                }))
            };
        }

        // 初始化数据表格
        function initDataTable() {
            const container = document.getElementById('tableArea');
            
            hot = new Handsontable(container, {
                data: defaultData,
                colHeaders: ['Time', 'Fund', 'ETF', 'Total'],
                rowHeaders: true,
                contextMenu: true,
                language: 'zh-CN',
                height: 400,
                licenseKey: 'non-commercial-and-evaluation',
                colWidths: [100, 100, 100, 100],
                manualColumnResize: true,
                manualRowResize: true
            });
        }

        // 初始化代码编辑器
        function initEditor() {
            chartOptionsEditor = ace.edit('editChartOptionContainer');
            chartOptionsEditor.setTheme('ace/theme/dracula');
            chartOptionsEditor.session.setMode('ace/mode/json');
            chartOptionsEditor.setOptions({
                enableLiveAutocompletion: false,
                enableSnippets: false,
                showPrintMargin: false,
                wrap: true,
                fontSize: '14px'
            });
        }

        // 绑定事件
        function bindEvents() {
            const layui = window.layui;
            
            // 生成图表按钮
            document.getElementById('startGenerate').addEventListener('click', function() {
                if (myChart) {
                    const option = getChartOption();
                    myChart.setOption(option, true);
                    layui.layer.msg('图表已更新');
                }
            });
            
            // 自定义配置按钮
            document.getElementById('startCustom').addEventListener('click', function() {
                const currentOption = getChartOption();
                setEditorValue(JSON.stringify(currentOption, null, 2));
                
                layui.layer.open({
                    type: 1,
                    title: '自定义图表配置',
                    area: ['80%', '80%'],
                    content: document.getElementById('edit_chart_options'),
                    btn: ['应用配置', '取消'],
                    yes: function(index) {
                        try {
                            const customOption = JSON.parse(getEditorValue());
                            myChart.setOption(customOption, true);
                            layui.layer.close(index);
                            layui.layer.msg('自定义配置已应用');
                        } catch (e) {
                            layui.layer.msg('JSON格式错误: ' + e.message);
                        }
                    }
                });
            });
            
            // 上传Excel按钮
            document.getElementById('startUpload').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xls,.xlsx';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                            
                            if (hot && jsonData.length > 0) {
                                hot.loadData(jsonData);
                                layui.layer.msg('Excel数据已加载');
                            }
                        } catch (error) {
                            layui.layer.msg('文件读取失败: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };
                
                input.click();
            });
            
            // 下载图表按钮
            document.getElementById('startDownload').addEventListener('click', function() {
                if (!myChart) return;
                
                const format = document.getElementById('exportFormat').value;
                const width = parseInt(document.getElementById('chartWidth').value);
                const height = parseInt(document.getElementById('chartHeight').value);
                
                if (format === 'pdf') {
                    // PDF下载需要jspdf库
                    layui.layer.msg('PDF下载功能需要额外配置');
                    return;
                }
                
                // 图片下载
                const dataURL = myChart.getDataURL({
                    type: format,
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });
                
                const link = document.createElement('a');
                link.download = `chart.${format}`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // 表单变化事件
            ['theme', 'style', 'marker'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (myChart) {
                        const option = getChartOption();
                        myChart.setOption(option);
                    }
                });
            });
        }

        // 编辑器辅助函数
        function setEditorValue(value) {
            if (chartOptionsEditor && value) {
                chartOptionsEditor.setValue(value);
                chartOptionsEditor.clearSelection();
            }
        }

        function getEditorValue() {
            return chartOptionsEditor ? chartOptionsEditor.getValue() : '';
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            initDataTable();
            initEditor();
            bindEvents();
        });
    </script>
</body>
</html>