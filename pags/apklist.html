<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rb APK</title>
    <style>
        body {
            font-family: 'Inter', 'Roboto', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #f7faf6;
            color: #333;
        }

        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: #ffffff;
            border-bottom: 1px solid #dce5de;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .toolbar h1 {
            margin: 0;
            font-size: 20px;
            color: #2e7d32;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toolbar h1::before { content: "ğŸ“¦"; }

        .view-btn {
            padding: 6px 12px;
            border: 1px solid #cdd8d3;
            border-radius: 6px;
            background: #e8f5e9;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
            transition: all 0.2s ease;
        }
        .view-btn:hover {
            background: #dcedc8;
            transform: translateY(-1px);
        }

        .container {
            max-width: 900px;
            margin: 24px auto;
            padding: 20px 28px;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #dce5de;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* åˆ—è¡¨æ¨¡å¼ */
        #file-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #file-list li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: 1px solid #e0e5e0;
            border-radius: 6px;
            margin-bottom: 8px;
            background: #f9fdfb;
            transition: all 0.2s ease;
        }
        #file-list li:hover {
            background: #e8f5e9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #file-list a {
            color: #1565c0;
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
        }

        .apk-icon {
            width: 22px;
            height: 22px;
            background: linear-gradient(145deg, #4caf50, #43a047);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* æ—¥å†æ¨¡å¼ */
        .calendar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .day-cell {
            background: #f5faf5;
            border: 1px solid #dce5de;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .day-cell.today {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .day-cell h3 {
            font-size: 15px;
            margin: 0;
            color: #2e7d32;
            padding-bottom: 6px;
            border-bottom: 1px dashed #dce5de;
        }
        .day-cell a {
            font-size: 13px;
            padding: 4px 0;
            display: block;
        }

        /* æ–‡ä»¶åˆ†ç»„ */
        .file-group {
            margin-top: 24px;
        }
        .file-group h2 {
            font-size: 18px;
            color: #2e7d32;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e8f5e9;
        }

        .recent-files {
            background: #f9fdf9;
            border-left: 3px solid #4caf50;
            padding-left: 12px;
        }

        .older-files {
            background: #f5f5f5;
            border-left: 3px solid #757575;
            padding-left: 12px;
        }

        .oldest-files {
            background: #f0f0f0;
            border-left: 3px solid #9e9e9e;
            padding-left: 12px;
        }

        .file-group a {
            display: block;
            padding: 6px 0;
            color: #1565c0;
            text-decoration: none;
            font-size: 14px;
        }

        .file-group a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #757575;
            font-style: italic;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 20px;
            color: #2e7d32;
        }

        .error {
            text-align: center;
            padding: 20px;
            color: #b71c1c;
            background: #ffebee;
            border-radius: 6px;
        }

        /* æŒ‰å¤©åˆ†ç»„æ ·å¼ */
        .day-group {
            margin-bottom: 12px;
        }

        .day-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 8px 0;
        }

        .day-group:last-child .day-divider {
            display: none;
        }
    </style>
</head>
<body>

<div class="toolbar">
    <h1>Roombox apk</h1>
    <div>
        <button class="view-btn" id="toggleView">åˆ‡æ¢åˆ—è¡¨è§†å›¾</button>
    </div>
</div>

<div class="container">
    <div id="file-list">
        <div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
    </div>
</div>

<script>
    const BASE_PATH = "/apps/Android/RoomBox/Debug/";
    const FILE_LIST_URL = "http://10.203.12.99" + BASE_PATH;
    let isCalendarView = true; // é»˜è®¤è®¾ç½®ä¸ºæ—¥å†è§†å›¾
    let linksData = [];

    const toggleBtn = document.getElementById("toggleView");
    const fileListDiv = document.getElementById("file-list");

    toggleBtn.addEventListener("click", () => {
        isCalendarView = !isCalendarView;
        // æ›´æ–°æŒ‰é’®æ–‡æ¡ˆ
        toggleBtn.textContent = isCalendarView ? "åˆ‡æ¢åˆ—è¡¨è§†å›¾" : "åˆ‡æ¢æ—¥å†è§†å›¾";
        renderView();
    });

    // æ ¼å¼åŒ–æ—¥æœŸä¸ºä¸¤ä½æ•°
    function formatDateNumber(num) {
        return num < 10 ? '0' + num : num.toString();
    }

    function parseDateFromAPK(name) {
        const match = name.match(/\((\d{10})\)/);
        if (!match) return null;
        const dateStr = match[1].substring(0,8);
        const year = parseInt(dateStr.substring(0,4));
        const month = parseInt(dateStr.substring(4,6)) - 1;
        const day = parseInt(dateStr.substring(6,8));
        return new Date(year, month, day);
    }

    function groupFilesByDate(files) {
        const today = new Date();
        const oneWeekAgo = new Date(today);
        oneWeekAgo.setDate(today.getDate() - 7);

        const fourWeeksAgo = new Date(today);
        fourWeeksAgo.setDate(today.getDate() - 28);

        const recentFiles = []; // æœ€è¿‘ä¸€å‘¨
        const olderFiles = [];  // 1-4å‘¨å‰
        const oldestFiles = []; // æ›´æ—©çš„æ–‡ä»¶
        const noDateFiles = []; // æ— æ³•è§£ææ—¥æœŸçš„æ–‡ä»¶

        files.forEach(name => {
            const date = parseDateFromAPK(name);
            if (!date) {
                noDateFiles.push(name);
                return;
            }

            if (date >= oneWeekAgo) {
                recentFiles.push({name, date});
            } else if (date >= fourWeeksAgo) {
                olderFiles.push({name, date});
            } else {
                oldestFiles.push({name, date});
            }
        });

        // æŒ‰æ—¥æœŸæ’åº - æœ€è¿‘çš„æ–‡ä»¶åœ¨å‰
        recentFiles.sort((a, b) => b.date - a.date);
        olderFiles.sort((a, b) => b.date - a.date);
        oldestFiles.sort((a, b) => b.date - a.date);

        return { recentFiles, olderFiles, oldestFiles, noDateFiles };
    }

    // æŒ‰å¤©åˆ†ç»„æ–‡ä»¶
    function groupFilesByDay(files) {
        const groups = {};
        files.forEach(file => {
            const dateKey = file.date.toDateString();
            if (!groups[dateKey]) {
                groups[dateKey] = [];
            }
            groups[dateKey].push(file);
        });

        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        return Object.keys(groups)
            .map(dateKey => ({
                date: new Date(dateKey),
                files: groups[dateKey]
            }))
            .sort((a, b) => b.date - a.date);
    }

    function renderView() {
        fileListDiv.innerHTML = "";

        if (linksData.length === 0) {
            fileListDiv.innerHTML = "<div class='loading'>æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>";
            return;
        }

        if (!isCalendarView) {
            // åˆ—è¡¨æ¨¡å¼
            const ul = document.createElement("ul");
            linksData.forEach(name => {
                const li = document.createElement("li");
                const icon = document.createElement("div");
                icon.className = "apk-icon";
                icon.textContent = "APK";
                const a = document.createElement("a");
                a.href = FILE_LIST_URL + name;
                a.textContent = name;
                li.appendChild(icon);
                li.appendChild(a);
                ul.appendChild(li);
            });
            fileListDiv.appendChild(ul);
        } else {
            // æ—¥å†æ¨¡å¼ - çºµå‘æ’åˆ—
            const { recentFiles, olderFiles, oldestFiles, noDateFiles } = groupFilesByDate(linksData);

            // æœ€è¿‘ä¸€å‘¨çš„æ–‡ä»¶ - ç”¨æ—¥å†è§†å›¾å±•ç¤º
            if (recentFiles.length > 0) {
                const recentGroup = document.createElement("div");
                recentGroup.className = "file-group recent-files";

                const title = document.createElement("h2");
                // title.textContent = "æœ€è¿‘ä¸€å‘¨çš„ APK æ–‡ä»¶";
                title.textContent = "Recent Week";
                recentGroup.appendChild(title);

                const calendarDiv = document.createElement("div");
                calendarDiv.className = "calendar";

                const today = new Date();
                const weekDates = [];
                // æœ€è¿‘æ—¥æœŸåœ¨å‰ï¼Œç”±è¿‘åŠè¿œ
                for(let i=0; i<7; i++){
                    const d = new Date(today);
                    d.setDate(today.getDate()-i);
                    weekDates.push(d);
                }

                weekDates.forEach(date => {
                    const dayCell = document.createElement("div");
                    dayCell.className = "day-cell";
                    if(date.toDateString() === today.toDateString()) dayCell.classList.add("today");

                    const dayTitle = document.createElement("h3");
                    const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                    dayTitle.textContent = `${formatDateNumber(date.getMonth()+1)}/${formatDateNumber(date.getDate())} ${dayNames[date.getDay()]}`;
                    dayCell.appendChild(dayTitle);

                    let hasFile = false;
                    recentFiles.forEach(file => {
                        if(file.date.toDateString() === date.toDateString()){
                            const a = document.createElement("a");
                            a.href = FILE_LIST_URL + file.name;
                            a.textContent = file.name;
                            dayCell.appendChild(a);
                            hasFile = true;
                        }
                    });

                    if (!hasFile) {
                        const emptyMsg = document.createElement("div");
                        emptyMsg.className = "empty-state";
                        emptyMsg.textContent = "æ—  APK æ–‡ä»¶";
                        dayCell.appendChild(emptyMsg);
                    }

                    calendarDiv.appendChild(dayCell);
                });

                recentGroup.appendChild(calendarDiv);
                fileListDiv.appendChild(recentGroup);
            }

            // 1-4å‘¨å‰çš„æ–‡ä»¶ - æŒ‰å¤©åˆ†ç»„
            if (olderFiles.length > 0) {
                const olderGroup = document.createElement("div");
                olderGroup.className = "file-group older-files";

                const title = document.createElement("h2");
                // title.textContent = "è¿‘æœŸ APK æ–‡ä»¶ (1-4å‘¨å‰)";
                title.textContent = "Recent (1-4 weeks)";
                olderGroup.appendChild(title);

                const dayGroups = groupFilesByDay(olderFiles);

                dayGroups.forEach(dayGroup => {
                    const dayContainer = document.createElement("div");
                    dayContainer.className = "day-group";

                    dayGroup.files.forEach(file => {
                        const a = document.createElement("a");
                        a.href = FILE_LIST_URL + file.name;
                        a.textContent = `${formatDateNumber(file.date.getMonth()+1)}/${formatDateNumber(file.date.getDate())} - ${file.name}`;
                        dayContainer.appendChild(a);
                    });

                    // æ·»åŠ åˆ†å‰²çº¿
                    const divider = document.createElement("div");
                    divider.className = "day-divider";
                    dayContainer.appendChild(divider);

                    olderGroup.appendChild(dayContainer);
                });

                fileListDiv.appendChild(olderGroup);
            }

            // æ›´æ—©çš„æ–‡ä»¶ - æŒ‰å¤©åˆ†ç»„
            if (oldestFiles.length > 0) {
                const oldestGroup = document.createElement("div");
                oldestGroup.className = "file-group oldest-files";

                const title = document.createElement("h2");
                // title.textContent = "æ›´æ—©çš„ APK æ–‡ä»¶";
                title.textContent = "Archive";
                oldestGroup.appendChild(title);

                const dayGroups = groupFilesByDay(oldestFiles);

                dayGroups.forEach(dayGroup => {
                    const dayContainer = document.createElement("div");
                    dayContainer.className = "day-group";

                    dayGroup.files.forEach(file => {
                        const a = document.createElement("a");
                        a.href = FILE_LIST_URL + file.name;
                        a.textContent = `${file.date.getFullYear()}/${formatDateNumber(file.date.getMonth()+1)}/${formatDateNumber(file.date.getDate())} - ${file.name}`;
                        dayContainer.appendChild(a);
                    });

                    // æ·»åŠ åˆ†å‰²çº¿
                    const divider = document.createElement("div");
                    divider.className = "day-divider";
                    dayContainer.appendChild(divider);

                    oldestGroup.appendChild(dayContainer);
                });

                fileListDiv.appendChild(oldestGroup);
            }

            // æ— æ³•è§£ææ—¥æœŸçš„æ–‡ä»¶
            if (noDateFiles.length > 0) {
                const noDateGroup = document.createElement("div");
                noDateGroup.className = "file-group";

                const title = document.createElement("h2");
                // title.textContent = "å…¶ä»– APK æ–‡ä»¶ (æ— æ³•è§£ææ—¥æœŸ)";
                title.textContent = "Others (No date)";
                noDateGroup.appendChild(title);

                noDateFiles.forEach(name => {
                    const a = document.createElement("a");
                    a.href = FILE_LIST_URL + name;
                    a.textContent = name;
                    noDateGroup.appendChild(a);
                });

                fileListDiv.appendChild(noDateGroup);
            }
        }
    }

    // === è·å–æ–‡ä»¶åˆ—è¡¨ ===
    fetch(FILE_LIST_URL)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.text();
        })
        .then(data => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(data, "text/html");
            linksData = Array.from(doc.querySelectorAll("a"))
                .map(a => a.textContent)
                .filter(n => n.endsWith(".apk"));
            renderView();
        })
        .catch(err => {
            fileListDiv.innerHTML = `<div class="error">æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨ã€‚<br>é”™è¯¯ä¿¡æ¯: ${err.message}</div>`;
            console.error(err);
        });
</script>

</body>
</html>